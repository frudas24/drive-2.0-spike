<html>

<head>

</head>

<body>

<style type="text/css">
  .header {
    position: fixed;
    width: 100%;
    top: 0;
    height: 30px;
    background: silver;
    border-bottom: 1px solid black;
  }
  .status {
    right: 0px;
    position: absolute;
    padding-right: 20px;
  }
  body {
    padding: 0;
    margin: 0;
  }
  .filename {
    font-size: 20px;
    font-weight: bold;
    padding-left: 20px;
    padding-right: 20px;
    text-decoration: none;
    color: black;
    cursor: pointer;
  }
  .profile.email {
    font-size: 10px;
    padding-left: 20px;
    padding-right: 20px;
  }
  
</style>
<div class="header">
  <a class="filename" title="Rename"></a>
  <span class="profile email"></span>
  <span id="status" class="status">
    Initialising...
  </span>
</div>

<div id="manual-login" style="display:none">
  Could not log in automatically. Please <button id="login">Sign In With Google</button>
</div>
<%= erb :vendor_scripts %>
<%= erb :own_scripts %>

<script>

var setStatus = function (statusMsg) {
    document.getElementById('status').innerHTML=statusMsg;
  },
  defaultTitle = 'all new untitled mind map',
  filePathPrefix = '/drive/file/',
  initialContent = {id: 1, title: defaultTitle},
  mm2CollaborationModel = new MM2.CollaborationModel(initialContent),
  activeContentListener = new MM2.CollaborationModelActiveContentListener(mm2CollaborationModel),
  authenticator = new MM2.GoogleAuthenticatorService({
      client_id:'<%=ENV['GOOGLE_OAUTH_CLIENT_ID']%>', 
      scope: '<%=settings.startup_drive_scopes%>',
      'cookie_policy': 'single_host_origin'
  }),
  googleDriveService = new MM2.GoogleDriveService(),
  googleDrivePageController = new MM2.GoogleDrivePageController (defaultTitle, filePathPrefix, authenticator, googleDriveService);

window.addEventListener('MM:GoogleScriptsFailed', function () {
  setStatus('Sadly, Google Script Loading failed!');
});

window.addEventListener('MM:GoogleScriptsLoaded', function () {
  if (!window.jQuery) {
    setStatus('Sadly, Vendor Script Loading failed!');
    }
  var pageInitialised = function (fileId, fileName, userProfile) {
    $('#manual-login').hide();
    $('.filename').text(fileName).on('click', function () {
       var newName = prompt('New file name', this.innerHTML);
        if (newName) {
          googleDriveService.renameFile(fileId, newName).then(function (fileMeta) {
            document.title = fileMeta.title;
            $('.filename').text(fileMeta.title);
          }, 
          function (jqXHR, errorText, thrownError) {
            console.log(thrownError);
            setStatus('Sadly, renaming failed ' + errorText);
          });
        }
    });
    document.title = fileName;
    $('.profile.email').text(userProfile.getEmail());
    MM2.mediateDriveRealtimeEvents(fileId, mm2CollaborationModel, function(error) {
        console.log(error);
        setStatus('Error', error);
    }/*, console.log.bind(console)*/);
  }, 
  handleControllerErrors = function (reason) {
    if (reason === 'not-authenticated') {
      $('#manual-login').show();  
    } else {
      setStatus(reason);
    }
  };
  googleDrivePageController.initPage().then(pageInitialised, handleControllerErrors, setStatus);
  $('#login').on('click', function () {
    googleDrivePageController.initPage(true).then(pageInitialised, handleControllerErrors, setStatus);
  });
});

activeContentListener.addEventListener('mm-active-content-changed', function (activeContent, newSession, method, args) {
  if (newSession) {
    console.log('new session', activeContent);
  }
  else {
    console.log('change event', method, args);
  }
});
mm2CollaborationModel.addEventListener('sessionInitialized', function () {
  setStatus('document loaded');
});

</script>
<%= erb :google_load_scripts %>
</body>
</html>
